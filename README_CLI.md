# Static Malware Analysis Automation Framework — CLI

The CLI, based on [Typer](https://typer.tiangolo.com/), orchestrates the entire static analysis pipeline: importing disassemblies, ML model inference, IOC/YARA extraction, and report generation.

La CLI basata su [Typer](https://typer.tiangolo.com/) consente di orchestrare l’intera pipeline di analisi statica: import dei disassemblati, inferenza del modello ML, estrazione IOC/YARA e generazione report.

---

## Requirements / Requisiti
* Python ≥ 3.9
* Main dependencies: `typer`, `jinja2`, `weasyprint`
* Project structure available (`core/`, `analyzer/`, `disassembler/`, `predictor/`, `reporting/`, `webapp/`).

* Dipendenze principali: `typer`, `jinja2`, `weasyprint`
* Struttura del progetto disponibile (cartelle `core/`, `analyzer/`, `disassembler/`, `predictor/`, `reporting/`, `webapp/`).

Quick installation / Installazione rapida:
```bash
git clone https://github.com/<tuo_repo>/static-malware-analyzer.git
cd static-malware-analyzer
pip install -r requirements.txt
```

Ensure that JSON files generated by Radare2 are present in  
`disassembler/disassembled/json/<sha256>.json` before running `assemble`.

Assicurati che i JSON generati da Radare2 siano presenti in  
`disassembler/disassembled/json/<sha256>.json` prima di lanciare `assemble`.

---

## Usage / Utilizzo
```bash
python cli.py --help
```

### Main Commands / Comandi principali
* **assemble**
  ```bash
  python cli.py assemble <sha256>
  ```
  Imports the static JSON and creates/updates the local artifact.  
  Importa il JSON statico e crea/aggiorna l’artefatto locale.

* **predict**
  ```bash
  python cli.py predict <sha256> --model-path predictor_artifacts/predictor_model.joblib
  ```
  Loads the model, extracts features, and saves verdict + classifier probabilities. Confidence percentage will later be shown in the reports.  
  Carica il modello, estrae le feature e salva verdetto + probabilità del classificatore. La percentuale di confidenza sarà poi mostrata nei report.

* **iocs**
  ```bash
  python cli.py iocs <sha256>
  ```
  Runs IOC/YARA correlation, updates threat intelligence feeds, and populates report signals.  
  Esegue correlazione IOC/YARA, aggiorna i feed di threat intelligence e popola i segnali che verranno evidenziati nel report.

* **report**
  ```bash
  python cli.py report <sha256>
  ```
  Generates the PDF using Jinja2 + WeasyPrint.  
  Genera il PDF sfruttando il template Jinja2 + WeasyPrint.

* **pipeline**
  ```bash
  python cli.py pipeline <sha256>
  ```
  Runs assemble → predict → iocs → report sequentially. Options `--model-path` and `--threshold` are also available here.  
  Esegue in sequenza assemble → predict → iocs → report. Opzioni `--model-path` e `--threshold` sono disponibili anche qui.

* **pipeline-all**
  ```bash
  python cli.py pipeline-all
  ```
  Applies the full pipeline to all JSON files in the configured directory (`DISASM_JSON`).  
  Applica la pipeline completa a tutti i JSON presenti nella directory configurata (`DISASM_JSON`).

### Optional Commands / Comandi opzionali
* **train-predictor**
  ```bash
  python cli.py train-predictor --malicious-dir samples/malicious --benign-dir samples/benign
  ```
  Extracts legacy features, saves `ml_vectors.bin`/`ml_index.jsonl`, and trains `predictor_model.joblib` + `training_summary.json`.  
  Estrae le feature legacy, salva `ml_vectors.bin`/`ml_index.jsonl` e addestra `predictor_model.joblib` + `training_summary.json`.

* **fetch-samples**
  ```bash
  python cli.py fetch-samples 100
  ```
  Downloads samples from MalwareBazaar using the integrated collector.  
  Scarica campioni da MalwareBazaar usando il collector integrato.

---

## Output
* `artifacts/<sha256>.json` – consolidated artifact.  
  Artefatto consolidato.
* `artifacts/<sha256>.pdf` / `artifacts/<sha256>.html` – reports.  
  Report.
* `artifacts/structured/<sha256>/` – structured JSON exports (scan + network).  
  Esportazioni JSON (scan + network).

---

## Notes / Note
* `assemble` fails if Radare2 JSON is unavailable.  
  `assemble` fallisce se il JSON Radare2 non è disponibile.
* WeasyPrint requires native dependencies (cairo, pango, gdk-pixbuf, libffi).  
  WeasyPrint richiede dipendenze native (cairo, pango, gdk-pixbuf, libffi).
* The ML model path is configurable via `SMAAF_PREDICTOR_MODEL` variable or CLI options.  
  Il percorso del modello ML è configurabile tramite variabile `SMAAF_PREDICTOR_MODEL` oppure opzioni CLI.

© 2025 — Gregorio Garofalo
